# -*- coding: utf-8 -*-
from filecmp import cmp
import subprocess
import os

# Current Directory
cwd = os.getcwd()
sep = os.path.sep

# Start points for file paths
cleanFilePath = cwd + sep + 'Ultima_5_Clean' + sep
manipFilePath = cwd + sep + 'Ultima_5' + sep

# Main Character Stat Byte Offset Constants
MC_Strength = 14
MC_Dexterity = 15
MC_Intelligence = 16
MC_Magic = 17
MC_Hp1 = 18
MC_Hp2 = 19
MC_Hmax1 = 20
MC_Hmax2 = 21
MC_Exp1 = 22
MC_Exp2 = 23
MC_Gold1 = 516
MC_Gold2 = 517

# Check if two files (with the same name) are identical and
# returns a dictionary of files different from the working version.
def isIdenticalFiles():
    # Read in the file names to a list.
    readFile = 'Ultima_File_Names.txt'
    fo = open(readFile)
    fileList = fo.read().split('\n')
    
    fileDict = {}
    for file in fileList:
        tempCleanPath = cleanFilePath + file
        tempManipPath = manipFilePath + file
        if (not cmp(tempCleanPath, tempManipPath, False)):
            fileDict[file] = cmp(tempCleanPath, tempManipPath, False)
    return fileDict

# Create Temp File from Clean File
def openTempFile (filePath = manipFilePath + 'SAVED.GAM'):
    f = open(filePath, 'rb')
    byteData = f.read()
    f.close()
    
    fTemp = open(manipFilePath + 'tempFile.GAM', 'wb')
    fTemp.write(byteData)
    fTemp.close()

# Modifies a Decimal List of Values
def modMainCharacterStats(decList):
    decList[MC_Strength] = 0
    decList[MC_Dexterity] = 0
    decList[MC_Intelligence] = 99
    decList[MC_Magic] = 99
    decList[MC_Hp1] = 231
    decList[MC_Hp2] = 3
    decList[MC_Hmax1] = 231
    decList[MC_Hmax2] = 3
    decList[MC_Exp1] = 15
    decList[MC_Exp2] = 39
    decList[MC_Gold1] = 15
    decList[MC_Gold2] = 39
    return decList


def modSaveState(filePath = manipFilePath + 'SAVED.GAM'):
    # Open Read
    fIn = open(filePath, 'rb')
    
    # Read
    byteData = fIn.read()
    
    # Convert Bytes to List
    decDataList = []
    for byte in byteData:
        decDataList.append(byte)
    
    # Close Read
    fIn.close()
    
    # Open Write
    fOut = open(filePath, 'wb')
    
    # Modify the List
    decDataList = modMainCharacterStats(decDataList)
    
    # Convert List to Bytes
    modByteData = bytes(decDataList)
    
    # Write to File
    fOut.write(modByteData)
    
    # Close write file
    fOut.close()
    
    
# Worked On this... Didnt get far enough!! Just showing you what I tried working on.
def getFileProcessModule (filePath = manipFilePath + 'SAVED.GAM'):
    listProcessCompleted = subprocess.run(['ls'])
    print(listProcessCompleted.stdout)
    print(listProcessCompleted.stderr)
    
    listProcessOutput = subprocess.check_output(['ls'])
    print(listProcessOutput)
    
    listProcessOutput2 = subprocess.getoutput(['ls'])
    print('LPO2: ' + listProcessOutput2)
    
    #Change directory
    print(subprocess.popen(['cd', 'Ultima_5', ';', 'xxd', '-p', 'SAVED.GAM', '>', 'saveTemp.txt', '|', 'mv', 'saveTemp.txt', '..', ';', 'cd', '..']))

    subprocess
        
    #Create Hex Dump
    #print(subprocess.run(['xxd', '-p', 'SAVED.GAM', '>', 'saveTemp.txt']))
    
    #Move the file
    #print(subprocess.run(['mv', 'saveTemp.txt', '..']))
    
    #Change directories back
    #print(subprocess.run(['cd', '..']))
    
    #string = 'cd ~/Documents/Ultima_5 xxd -p SAVED.GAM > saveTemp.txt'
    
    # cd Ultima_5 ; xxd -p SAVED.GAM > saveTemp.txt |  mv saveTemp.txt .. ; cd ..
    
    

# Execute the Malware
modSaveState()